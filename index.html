<!doctype html>
<html lang="zh">
<meta charset="utf-8">
<title>ç•ªèŒ„å·¥ä½œæ¿ â€“ ä»»åŠ¡æ€»è§ˆå³ä¾§</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body{font-family:system-ui,sans-serif;margin:16px;}
#container{display:flex;flex-wrap:wrap;gap:16px;}
.panel{border:1px solid #ccc;border-radius:6px;padding:12px;flex:1 1 300px;min-width:260px;}
h3{margin-top:0;font-size:1.1rem;text-align:center;}
table{width:100%;border-collapse:collapse;}
th,td{border:1px solid #ccc;padding:6px 8px;text-align:center;}
td[contenteditable]{outline:none;}
button{padding:6px 10px;cursor:pointer;}
.delbtn{background:#eee;border:1px solid #bbb;font-size:1rem;}
li{border:1px solid #ccc;margin-bottom:4px;padding:6px 8px;list-style:none;}
li[contenteditable]{outline:none;}
.listDel{float:right;margin-left:8px;}
@media(max-width:600px){
  #container{flex-direction:column;}
}
</style>
<body>
<h2 id="date"></h2>

<div id="container">

  <!-- ä»Šæ—¥ç•ªèŒ„ -->
  <section class="panel">
    <h3>ä»Šæ—¥ç•ªèŒ„</h3>
    <table id="todayTbl">
      <thead><tr><th>ä»»åŠ¡</th><th>é¢„ä¼°ğŸ…</th><th>å®ŒæˆğŸ…</th><th>å®Œæˆâœ”</th></tr></thead>
      <tbody></tbody>
    </table>
    <p><button onclick="addTodayRow()">+ æ–°ä»»åŠ¡</button></p>
  </section>

  <!-- æ‰“æ–­è®°å½• -->
  <section class="panel">
    <h3>è¢«æ‰“æ–­è®°å½•</h3>
    <ul id="ints"></ul>
    <p><button onclick="addInt()">+ è®°å½•æ‰“æ–­</button></p>
  </section>

  <!-- ä»»åŠ¡æ€»è§ˆ (æ”¾åˆ°æœ€å/å³è¾¹) -->
  <section class="panel">
    <h3>ä»»åŠ¡æ€»è§ˆ</h3>
    <table id="allTbl">
      <thead><tr><th>æˆªæ­¢</th><th>ä»»åŠ¡</th><th>å¤‡æ³¨</th><th>å®Œæˆâœ”</th></tr></thead>
      <tbody></tbody>
    </table>
    <p><button onclick="addAllRow()">+ æ–°ä»»åŠ¡</button></p>
  </section>


  <!-- å†å²ç»Ÿè®¡ -->
  <section class="panel">
    <h3>å†å²å®Œæˆç•ªèŒ„</h3>
    <canvas id="statsChart"></canvas>
  </section>
</div>

<script>
const todayStr = new Date().toISOString().slice(0,10);
document.getElementById('date').textContent = todayStr;
function $(id){return document.getElementById(id);}

// é€šç”¨åˆ é™¤
function delRow(btn){
  const tr = btn.closest('tr');
  const tblId = btn.closest('table').id;
  tr.remove();
  if(tblId==='todayTbl') saveToday();
  else if(tblId==='allTbl') saveAll();
}

/* ä»Šæ—¥ç•ªèŒ„ */
const todayBody = $('todayTbl').querySelector('tbody');
function addTodayRow(task='', est='', done=0){
  const tr = todayBody.insertRow();
  tr.innerHTML = `
    <td contenteditable>${task}</td>
    <td contenteditable>${est}</td>
    <td><button onclick="incTomato(this)">${done}</button></td>
    <td><button class="delbtn" onclick="delRow(this)">âœ”</button></td>`;
  saveToday();
}
function incTomato(btn){
  btn.textContent = +btn.textContent + 1;
  saveToday();
}
function saveToday(){
  const data=[...todayBody.rows].map(r=>[
    r.cells[0].textContent.trim(),
    r.cells[1].textContent.trim(),
    r.cells[2].firstChild.textContent
  ]);
  localStorage.setItem('pomo_today_'+todayStr, JSON.stringify(data));
}
function loadToday(){
  (JSON.parse(localStorage.getItem('pomo_today_'+todayStr)||'[]'))
    .forEach(([t,e,d])=>addTodayRow(t,e,d));
}

/* å…¨ä»»åŠ¡è¡¨ */
const allBody = $('allTbl').querySelector('tbody');
function addAllRow(deadline='', task='', note=''){
  const tr = allBody.insertRow();
  tr.innerHTML = `
    <td contenteditable>${deadline}</td>
    <td contenteditable>${task}</td>
    <td contenteditable>${note}</td>
    <td><button class="delbtn" onclick="delRow(this)">âœ”</button></td>`;
  saveAll();
}
function saveAll(){
  const data=[...allBody.rows].map(r=>[
    r.cells[0].textContent.trim(),
    r.cells[1].textContent.trim(),
    r.cells[2].textContent.trim()
  ]);
  localStorage.setItem('pomo_allTasks', JSON.stringify(data));
}
function loadAll(){
  (JSON.parse(localStorage.getItem('pomo_allTasks')||'[]'))
    .forEach(([d,t,n])=>addAllRow(d,t,n));
}

/* æ‰“æ–­è®°å½• */
const ints = $('ints');
function addInt(text=''){
  const li = document.createElement('li');
  li.contentEditable = true;
  li.textContent = text;
  const del = document.createElement('button');
  del.textContent='âœ”';
  del.className='listDel delbtn';
  del.onclick = ()=>{ li.remove(); saveInts(); };
  li.appendChild(del);
  li.oninput = saveInts;
  ints.appendChild(li);
  saveInts();
}
function saveInts(){
  const data = [...ints.children].map(li=>li.firstChild.textContent.trim());
  localStorage.setItem('pomo_interrupt_'+todayStr, JSON.stringify(data));
}
function loadInts(){
  (JSON.parse(localStorage.getItem('pomo_interrupt_'+todayStr)||'[]'))
    .forEach(txt=>addInt(txt));
}

loadToday();
loadAll();
loadInts();
</script>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// ç»Ÿè®¡ localStorage é‡Œ pomo_today_YYYY-MM-DD é”®
function getHistoryData(days=30){
  const data = {};
  for (let i=0;i<localStorage.length;i++){
    const k = localStorage.key(i);
    if(k.startsWith('pomo_today_')){
      const date = k.slice(11);
      try{
        const arr = JSON.parse(localStorage.getItem(k));
        const total = arr.reduce((sum,row)=> sum + Number(row[2]||0),0);
        data[date]=total;
      }catch(e){}
    }
  }
  // æœ€è¿‘ days å¤©
  const today = new Date();
  const labels=[], values=[];
  for(let d=days-1; d>=0; d--){
    const day = new Date(today);
    day.setDate(today.getDate()-d);
    const ds = day.toISOString().slice(0,10);
    labels.push(ds);
    values.push(data[ds]||0);
  }
  return {labels, values};
}

function drawChart(){
  const ctx = document.getElementById('statsChart');
  if(!ctx) return;
  const {labels, values} = getHistoryData(30);
  new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [{
        label: 'å®Œæˆç•ªèŒ„æ•°',
        data: values
      }]
    },
    options: {
      scales: {
        x: {ticks:{autoSkip:true, maxRotation:45, minRotation:45}},
        y: {beginAtZero:true, precision:0}
      }
    }
  });
}
drawChart();
</script>
</body>
</html>